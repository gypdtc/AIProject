name: Deploy Stock Scanner System

on:
  push:
    branches: [ "main" ]

env:
  PROJECT_ID: gen-lang-client-0486815668 
  REGION: us-central1
  REPO_NAME: stock-scanner-repo
  # 定义三个组件的名称
  SERVICE_NAME: stock-scanner-service
  UI_SERVICE_NAME: stock-scanner-ui
  JOB_NAME: stock-analyst-job

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Google Auth
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v2

    - name: Docker Auth
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

    - name: Build and Push Image
      run: |
        IMAGE_PATH="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/app"
        # 使用 commit SHA 作为版本标签
        docker build -t $IMAGE_PATH:${{ github.sha }} .
        docker tag $IMAGE_PATH:${{ github.sha }} $IMAGE_PATH:latest
        
        docker push $IMAGE_PATH:${{ github.sha }}
        docker push $IMAGE_PATH:latest

    - name: Deploy API Service
      run: |
        # 更新主要的 FastAPI 后端
        gcloud run services update ${{ env.SERVICE_NAME }} \
          --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/app:${{ github.sha }} \
          --region ${{ env.REGION }} \
          --set-env-vars "DATABASE_URL=${{ secrets.DATABASE_URL }},GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }},INTERNAL_AUTH_KEY=${{ secrets.INTERNAL_AUTH_KEY }}"

    - name: Deploy Streamlit UI
      run: |
        # 更新可视化看板服务
        # 注意：这里需要覆盖启动命令来运行 streamlit
        gcloud run services update ${{ env.UI_SERVICE_NAME }} \
          --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/app:${{ github.sha }} \
          --region ${{ env.REGION }} \
          --command "streamlit,run,dashboard.py,--server.port=8080,--server.address=0.0.0.0" \
          --set-env-vars "DATABASE_URL=${{ secrets.DATABASE_URL }}"

    - name: Update Analyst Job
      run: |
        # 更新每日分析脚本的任务定义
        gcloud run jobs update ${{ env.JOB_NAME }} \
          --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/app:${{ github.sha }} \
          --region ${{ env.REGION }} \
          --set-env-vars "DATABASE_URL=${{ secrets.DATABASE_URL }},DASHBOARD_PASSWORD=${{ secrets.DASHBOARD_PASSWORD }}"